#!/bin/bash
set -e

### Color
Green="\e[92;1m"
RED="\033[31m"
YELLOW="\033[33m"
BLUE="\033[36m"
FONT="\033[0m"
OK="${Green}--->${FONT}"
ERROR="${RED}[ERROR]${FONT}"

### Status
function print_ok() {
    echo -e "${OK} ${BLUE} $1 ${FONT}"
}

function print_install() {
    echo -e "${YELLOW} ============================================ ${FONT}"
    echo -e "${YELLOW} # $1 ${FONT}"
    echo -e "${YELLOW} ============================================ ${FONT}"
    sleep 1
}

function print_error() {
    echo -e "${ERROR} ${RED} $1 ${FONT}"
}

function print_success() {
    if [[ $? -eq 0 ]]; then
        echo -e "${Green} ============================================ ${FONT}"
        echo -e "${Green} # $1 Successfully installed"
        echo -e "${Green} ============================================ ${FONT}"
        sleep 2
    fi
}

### Check root
function is_root() {
    if [[ $EUID -ne 0 ]]; then
        print_error "This script must be run as root!"
        exit 1
    fi
}

### Update and Install Packages
function install_packages() {
    print_install "Updating and installing required packages"
    apt update && apt upgrade -y
    apt install -y wget curl unzip
    print_success "Packages installed successfully"
}

### Install x-ui
function install_xui() {
    print_install "Installing x-ui"

    # Download and Install x-ui
    wget -O x-ui-linux-amd64.zip https://github.com/x-ui/x-ui/releases/latest/download/x-ui-linux-amd64.zip
    unzip x-ui-linux-amd64.zip -d /usr/local/x-ui
    chmod +x /usr/local/x-ui/x-ui

    # Set up x-ui service
    cat > /etc/systemd/system/x-ui.service <<EOF
[Unit]
Description=x-ui service
After=network.target

[Service]
ExecStart=/usr/local/x-ui/x-ui
Restart=on-failure
User=root

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl start x-ui
    systemctl enable x-ui

    print_success "x-ui installed and started successfully"
}

### Install V2Ray
function install_v2ray() {
    print_install "Installing V2Ray"

    # Download and Install V2Ray
    wget -O v2ray-linux-amd64.zip https://github.com/v2fly/v2ray-core/releases/latest/download/v2ray-linux-amd64.zip
    unzip v2ray-linux-amd64.zip -d /usr/local/v2ray
    chmod +x /usr/local/v2ray/v2ray
    chmod +x /usr/local/v2ray/v2ctl

    # Set up V2Ray service
    cat > /etc/systemd/system/v2ray.service <<EOF
[Unit]
Description=V2Ray Service
After=network.target

[Service]
ExecStart=/usr/local/v2ray/v2ray -config /usr/local/v2ray/config.json
Restart=on-failure
User=root

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl start v2ray
    systemctl enable v2ray

    print_success "V2Ray installed and started successfully"
}

### Main
function main() {
    is_root
    install_packages
    install_xui
    install_v2ray
}

main
